name: Release on version change

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.version.outputs.CURRENT_VERSION }}
      tag_exists: ${{ steps.tag.outputs.EXISTS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7

      - name: Get version
        id: version
        run: |
          CURRENT_VERSION=$(uv version --short)
          echo "Current version: ${CURRENT_VERSION}"
          echo "CURRENT_VERSION=${CURRENT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Check version tag existence
        id: tag
        run: |
          if git rev-parse "refs/tags/${{ steps.version.outputs.CURRENT_VERSION }}" >/dev/null 2>&1; then
            echo "EXISTS=true" >> "$GITHUB_OUTPUT"
          else
            echo "EXISTS=false" >> "$GITHUB_OUTPUT"
          fi

  release:
    needs: check
    if: needs.check.outputs.tag_exists == 'false'
    runs-on: ubuntu-latest
    permissions:
      id-token: write # for PyPI trusted publishing.
      contents: read # for PyPI trusted publishing.
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7

      - name: Build wheel
        id: wheel
        shell: bash
        run: |
          set -euo pipefail
          uv build --wheel --out-dir dist --clear
          WHEEL_PATH=$(ls dist/*.whl | head -n 1)
          echo "Found wheel: ${WHEEL_PATH}"
          echo "WHEEL_PATH=${WHEEL_PATH}" >> "$GITHUB_OUTPUT"
          echo "WHEEL_NAME=$(basename "${WHEEL_PATH}")" >> "$GITHUB_OUTPUT"

      - name: Create Github draft release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.check.outputs.current_version }}
          name: ver.${{ needs.check.outputs.current_version }}
          body: |
            Automated release for version ${{ needs.check.outputs.current_version }}.
          draft: true
          prerelease: false
          files: ${{ steps.wheel.outputs.WHEEL_PATH }}

      - name: Publish to PyPI
        run: uv publish --trusted-publishing always
